<div id="techChoiceMenu" style="text-align:center">
    <h2>We’d like to hear your experiences with different types of online platforms. </h2>
    <p>Click below to choose the online platform that you would like to draw tarot cards for. </p>
    <p id="done-button" style="display: none">
        <input type="submit" value="I'm done!" class="btn btn-primary btn-lg" onclick="finish()">
    </p>
    <!-- The four columns -->
    <div id="" name="category1" class="row">
        <h2 style="text-align: left"></h2>
        <div class="column" name="tech1">
            <img src="" name="" alt="" style="width:100%" onclick="selectTechnology(this);">
        </div>
        <div class="column" name="tech2">
            <img src="" name="" alt="" style="width:100%" onclick="selectTechnology(this);">
        </div>
        <div class="column" name="tech3">
            <img src="" name="" alt="" style="width:100%" onclick="selectTechnology(this);">
        </div>
        <div id="" name="tech4" class="column">
            <svg width="70%" viewBox="0 0 16 16" class="bi bi-file-plus" fill="currentColor"
                 xmlns="http://www.w3.org/2000/svg" onclick="">
                <path fill-rule="evenodd"
                      d="M4 1h8a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2zm0 1a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1H4z"/>
                <path fill-rule="evenodd"
                      d="M8 5.5a.5.5 0 0 1 .5.5v1.5H10a.5.5 0 0 1 0 1H8.5V10a.5.5 0 0 1-1 0V8.5H6a.5.5 0 0 1 0-1h1.5V6a.5.5 0 0 1 .5-.5z"/>
            </svg>
            <img src="" name="" style="display:none; width:70%" onclick="selectTechnology(this)">
        </div>
    </div>
    <div id="" name="category2" class="row">
        <h2 style="text-align: left"></h2>
        <div class="column" name="tech1">
            <img src="" name="" alt="" style="width:100%" onclick="selectTechnology(this);">
        </div>
        <div class="column" name="tech2">
            <img src="" name="" alt="" style="width:100%" onclick="selectTechnology(this);">
        </div>
        <div class="column" name="tech3">
            <img src="" name="" alt="" style="width:100%" onclick="selectTechnology(this);">
        </div>
        <div id="" name= "tech4" class="column">
            <svg width="70%" viewBox="0 0 16 16" class="bi bi-file-plus" fill="currentColor"
                 xmlns="http://www.w3.org/2000/svg" onclick="showAddTech('dating')">
                <path fill-rule="evenodd"
                      d="M4 1h8a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2zm0 1a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1H4z"/>
                <path fill-rule="evenodd"
                      d="M8 5.5a.5.5 0 0 1 .5.5v1.5H10a.5.5 0 0 1 0 1H8.5V10a.5.5 0 0 1-1 0V8.5H6a.5.5 0 0 1 0-1h1.5V6a.5.5 0 0 1 .5-.5z"/>
            </svg>
            <img src="" name="" style="display:none; width:70%" onclick="selectTechnology(this)">
        </div>
    </div>
    <div id="" name="category3" class="row">
        <h2 style="text-align: left"></h2>
        <div class="column" name="tech1">
            <img src="" name="" alt="" style="width:100%" onclick="selectTechnology(this);">
        </div>
        <div class="column" name="tech2">
            <img src="" name="" alt="" style="width:100%" onclick="selectTechnology(this);">
        </div>
        <div class="column" name="tech3">
            <img src="" name="" alt="" style="width:100%" onclick="selectTechnology(this);">
        </div>
        <div id="" name="tech4" class="column">
            <svg width="70%" viewBox="0 0 16 16" class="bi bi-file-plus" fill="currentColor"
                 xmlns="http://www.w3.org/2000/svg" onclick="showAddTech('transportation')">
                <path fill-rule="evenodd"
                      d="M4 1h8a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2zm0 1a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1H4z"/>
                <path fill-rule="evenodd"
                      d="M8 5.5a.5.5 0 0 1 .5.5v1.5H10a.5.5 0 0 1 0 1H8.5V10a.5.5 0 0 1-1 0V8.5H6a.5.5 0 0 1 0-1h1.5V6a.5.5 0 0 1 .5-.5z"/>
            </svg>
            <img src="" name="" style="display:none; width:70%" onclick="selectTechnology(this)">
        </div>

    </div>
    <div id="" name="category4" class="row">
        <h2 style="text-align: left"></h2>
        <div class="column" name="tech1">
            <img src="" name="" alt="" style="width:100%" onclick="selectTechnology(this);">
        </div>
        <div class="column" name="tech2">
            <img src="" name="" alt="" style="width:100%" onclick="selectTechnology(this);">
        </div>
        <div class="column" name="tech3">
            <img src="" name="" alt="" style="width:100%" onclick="selectTechnology(this);">
        </div>
        <div id="" name="tech4" class="column">
            <svg width="70%" viewBox="0 0 16 16" class="bi bi-file-plus" fill="currentColor"
                 xmlns="http://www.w3.org/2000/svg" onclick="showAddTech('location')">
                <path fill-rule="evenodd"
                      d="M4 1h8a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2zm0 1a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1H4z"/>
                <path fill-rule="evenodd"
                      d="M8 5.5a.5.5 0 0 1 .5.5v1.5H10a.5.5 0 0 1 0 1H8.5V10a.5.5 0 0 1-1 0V8.5H6a.5.5 0 0 1 0-1h1.5V6a.5.5 0 0 1 .5-.5z"/>
            </svg>
            <img src="" name="" style="display:none; width:70%" onclick="selectTechnology(this)">
        </div>

    </div>
</div>

<div id="addTech" class="modal" style="display: none">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Add an App!</span>
            </div>
            <div class="modal-body">
                <h3>Please select a store type and the name of the App you want to add:</h3><br>
                <input type="radio" id="option1" name="addtech" value="google">
                <label for="option1">Android</label><br>
                <input type="radio" id="option2" name="addtech" value="apple">
                <label for="option2">iPhone</label><br>
                <input type="text" id="addTechName">
            </div>
            <div id="addTechFooter" class="modal-footer">
                <img id="addTechImage" src="" name="" style="display: none; float: left; width: 100px">
                <input type="submit" value="Confirm" class="btn btn-primary btn-lg" onclick="selectNewTech()"
                       style="display: none">
                <input type="submit" value="Search" class="btn btn-primary btn-lg" onclick="searchNewTech()">
            </div>
        </div>
    </div>
</div>

<div id="techForm" class="modal" style="display: none">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body">
                <h3>I use the online platform:</h3><br>
                <input type="radio" id="option1" name="techuse" value="daily">
                <label for="option1">Daily</label><br>
                <input type="radio" id="option2" name="techuse" value="often">
                <label for="option2">Often</label><br>
                <input type="radio" id="option3" name="techuse" value="sometimes">
                <label for="option3">Sometimes</label><br>
                <input type="radio" id="option4" name="techuse" value="never">
                <label for="option4">Never</label><br><br>
                <input type="submit" value="Submit" class="btn btn-primary btn-lg" onclick="saveForm()">
            </div>
        </div>
    </div>
</div>

<div id="tarotCards" style="display: none">

    <div id="cardContainer" class="cardcontainer">
        <div class="card" id="card1Box">
            <div class="thumb">
                <img src="img/card-Catalyst.png" onclick="cardClick2('card1')" style="position: absolute">
                <svg viewBox="0 0 16 16" class="bi bi-check-circle-fill" fill="currentColor"
                     xmlns="http://www.w3.org/2000/svg"
                     style="position: absolute; top: 0; left: 0; margin: 10px; display: none" width="10%">
                    <path fill-rule="evenodd"
                          d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"></path>
                </svg>
            </div>
        </div>
        <div id="card1Flip" class="card" onclick="cardFlip2('card1')" style="display: none; background-color: #11f897">
            <h3>The Catalyst</h3>
            <h4>How might rural cultural habits change how the product is used, adapted, or repurposed?</h4>
            <p>How bringing [the product] to a rural area would impact the rural environment and its features?</p>
            <p>How might [the product] change the cultural habits (social norms, etiquette, or traditions) of people
                living in rural areas?</p>
        </div>

        <div class="card" id="card2Box">
            <div class="thumb">
                <img src="img/card-Forgotten.png" onclick="cardClick2('card2')" style="position: absolute">
                <svg viewBox="0 0 16 16" class="bi bi-check-circle-fill" fill="currentColor"
                     xmlns="http://www.w3.org/2000/svg"
                     style="position: absolute; top: 0; left: 0; margin: 10px; display: none" width="10%">
                    <path fill-rule="evenodd"
                          d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"></path>
                </svg>
            </div>
        </div>
        <div id="card2Flip" class="card" onclick="cardFlip2('card2')" style="display: none; background-color: #ffbe9f">
            <h3>The Forgotten</h3>
            <h4>When you picture the user base of [the product], who do you think is excluded as a potential
                user?</h4>
            <p>If [rural users] used [the product], what would their experience be like?</p>
            <p>How can we change [the product] to better serve or design for [rural users]</p>
        </div>

        <div class="card" id="card3Box">
            <div class="thumb">
                <img src="img/card-RadioStar.png" onclick="cardClick2('card3')" style="position: absolute">
                <svg viewBox="0 0 16 16" class="bi bi-check-circle-fill" fill="currentColor"
                     xmlns="http://www.w3.org/2000/svg"
                     style="position: absolute; top: 0; left: 0; margin: 10px; display: none" width="10%">
                    <path fill-rule="evenodd"
                          d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"></path>
                </svg>
            </div>
        </div>
        <div id="card3Flip" class="card" onclick="cardFlip2('card3')" style="display: none; background-color: #aedf2a">
            <h3>The Radio Star</h3>
            <h4>What social or economic interaction disappears if your product is successful in rural contexts?</h4>
            <p>Who loses their job if [the product] is used in rural areas?</p>
            <p>What other local products or services can be replaced by [the product]?</p>
            <p>What rural industries, institutions, or policies would be affected if everyone used [the product]</p>
        </div>

        <div class="card" id="card4Box">
            <div class="thumb">
                <img src="img/card-ServiceDog.png" onclick="cardClick2('card4')" style="position: absolute">
                <svg viewBox="0 0 16 16" class="bi bi-check-circle-fill" fill="currentColor"
                     xmlns="http://www.w3.org/2000/svg"
                     style="position: absolute; top: 0; left: 0; margin: 10px; display: none" width="10%">
                    <path fill-rule="evenodd"
                          d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"></path>
                </svg>
            </div>
        </div>
        <div id="card4Flip" class="card" onclick="cardFlip2('card4')" style="display: none; background-color: #ff9400">
            <h3>The Service Dog</h3>
            <h4>If [the product] was entirely dedicated to empowering the lives of rural area population, what kind
                of impact could it make?</h4>
            <p>Would your use of [the product] make you or others vulnerable to harm or endangering rural
                culture?</p>
            <p>How can the widespread use of [the product] in rural settings disrupt or endanger environmental and
                social sustainability in rural contexts?</p>
        </div>
    </div>

    <div id="bellowCards" style="display: flex">
        <img src="" style="width: 20em; margin: 10px">
        <div id="controlButtons" style="display: grid; align-content: center">
            <input type="submit" value="Change Tech" class="btn btn-primary btn-lg" onclick="changeTech()" style="margin: 5px">
            <input type="submit" value="Submit Answers" class="btn btn-primary btn-lg" onclick="submitAnswers()" style="margin: 5px">
        </div>
        <div id="textboxArea" style="display: none">
            <h3>Please enter you answers below:</h3>
            <textarea id="txtAnswer" type="text" style="width: 90%"></textarea>
            <input type="submit" value="Save" class="btn btn-primary btn-lg" onclick="saveCardAnswer()">
        </div>
    </div>

</div>

<script>

    var technologies = {
        commerce: {
            id: 'local-commerce',
            name: 'Local Commerce',
            apps: [
                {image: 'img/tech-fbmarketplace.jpg', name: 'Facebook',
                    description: 'Facebook Marketplace is an embedded Facebook app to buy and sell items or services.'},
                {image: 'img/tech-offerup.png', name: 'OfferUp',
                    description: 'OfferUp is an online mobile-first marketplace with an emphasis on in-person transactions.'},
                {image: 'img/tech-nextdoor.png', name: 'Nextdoor',
                    description: 'Nextdoor is a hyperlocal social networking service for neighborhoods'},
            ]
        },
        dating: {
            id: 'dating',
            name: 'Dating',
            apps: [
                {image: 'img/tech-tinder.png', name: 'Tinder',
                    description: 'Tinder is an online dating application that allows users to anonymously swipe to like or dislike other profiles based on their photos, a small bio, and common interests.'},
                {image: 'img/tech-grindr.png', name: 'Grindr',
                    description: 'Grindr is an online dating application geared towards gay, bi and trans people.'},
                {image: 'img/tech-farmersonly.png', name: 'FarmersOnly',
                    description: 'FarmersOnly is a niche dating site that aims to help rural dwellers find dates with singles who understand their lifestyle and uphold the same values.'},
            ]

        },
        transportation: {
            id: 'transportation',
            name: 'Transportation',
            apps: [
                {image: 'img/tech-lyft.png', name: 'Lyft',
                    description: 'Lyft is a ridesharing company offering car rides, scooters, a bicycle-sharing system, and a food delivery service.'},
                {image: 'img/tech-uber.jpg', name: 'Uber',
                    description: 'Uber is a ride-hailing company offering ridesharing, ride service hailing, food delivery, and a micromobility system with electric bikes and scooters.'},
                {image: 'img/tech-libretaxi.png', name: 'LibreTaxi',
                    description: 'LibreTaxi is a free and open source alternative to Uber/Lyft connecting passengers and drivers.'},
            ]

        },
        location: {
            id: 'location',
            name: 'Location-based',
            apps: [
                {image: 'img/tech-pokemon.jpg', name: 'Pokemon',
                    description: 'Pokémon Go is a 2016 augmented reality mobile game.'},
                {image: 'img/tech-gmaps.png', name: 'GoogleMaps',
                    description: 'Google Maps is a web mapping service developed by Google.'},
                {image: 'img/tech-yelp.png', name: 'Yelp',
                    description: 'Yelp is a website and mobile app publish crowd-sourced reviews about businesses.'},
            ]

        }
    };
    var all_answers = {};
    var tech_answers = {};

    function selectTechnology(image) {
        var technology = image.name;
        var selected = $('#techChoiceMenu img[name="' + technology + '"]');

        $('#techChoiceMenu img').css('filter', 'grayscale(1)');
        selected.css('filter', 'grayscale(0)');

        if (technology in all_answers) {
            tech_answers = all_answers[technology];
        } else {
            tech_answers = resetAnswers();
            tech_answers.tech = technology;
        }
        $('#bellowCards img').attr('src', selected.attr('src'));
        $('#techForm').show();
    }

    function showAddTech(techCategorykey) {
        $('#techChoiceMenu img').css('filter', 'grayscale(1)');
        $('#addTech-'+ techCategorykey +' svg').attr('fill','blue');
        $('#addTech').attr('name', techCategorykey);
        $('#addTech').show();
    }

    function searchNewTech() {
        let storeSelection = $('input[name="addtech"]:checked');
        let searchTerm = $('#addTechName')[0].value;
        if (storeSelection.length > 0 && searchTerm.trim() !== '') {
            let store = storeSelection[0].value;
            searchAppStore(searchTerm, store);
        } else {
            $('#addTech h3').animate({opacity:0}, 200, "linear", function(){
                $(this).animate({opacity:1}, 200);
            });
        }
    }

    function searchAppStore(searchTerm, appStore) {
        //TODO: show loading gif!
        let searchURL = 'http://www.tmp12345.labinthewild.org/include/get_appstore.php?search='
                + searchTerm + '&store=' + appStore;
        $.ajax({
            url: encodeURI(searchURL),
            method: 'GET',
            crossDomain: true,
            success: function(data, status){
                console.log(data);
                let addTechImage = $('#addTechImage');
                addTechImage.attr('src', data['app_image']);
                addTechImage.attr('name', appStore + '_' + data['app_id']);
                addTechImage.show();
                $("#addTechFooter input").show();
            },
        });
    }

    function selectNewTech() {
        let chosenTechImage = $("#addTechImage");
        let category = $('#addTech').attr('name');
        $('#addTech-'+ category +' svg').hide();
        let addTechImage = $('#addTech-'+ category +' img');
        addTechImage.attr('src', chosenTechImage.attr('src'));
        addTechImage.attr('name', chosenTechImage.attr('name'));
        addTechImage.show();
        showTechMenu();
        //reset add new tech modal
        $('input[name="addtech"]').prop("checked", false);
        $('#addTechName')[0].value = '';
        $('#addTech').hide();
        $('#addTech').attr('name', '');
        chosenTechImage.attr('src', '');
        chosenTechImage.attr('name', '');
        chosenTechImage.hide();
        $('#addTechFooter input[value="Confirm"]').hide();
    }

    function saveForm() {
        var selected = $("#techForm input:checked");
        tech_answers.use = selected.val();

        console.log(tech_answers);
        selected.prop("checked", false);
        $('#techForm').hide();
        $('#techChoiceMenu').hide();
        $('#tarotCards').show();
    }

    function cardClick(card) {
        cardsReset();
        tech_answers.current_card = card;
        var cardBox = $('#' + card + 'Box');
        var cardFlip = $('#' + card + 'Flip');

        $('#flipContainer').css('display', 'flex');
        cardBox.css('opacity', 0);
        cardFlip.css('opacity', 1);
        cardFlip.show();
        $('#txtAnswer').val(tech_answers[tech_answers.current_card]);
        $('#textboxArea').show();
        $('#controlButtons').hide();
    }

    function cardClick2(card) {
        cardsReset2();
        tech_answers.current_card = card;
        var cardBox = $('#' + card + 'Box');
        var cardFlip = $('#' + card + 'Flip');

        cardBox.hide()
        cardFlip.show();
        $('#txtAnswer').val(tech_answers[tech_answers.current_card]);
        $('#textboxArea').show();
        $('#controlButtons').hide();
    }

    function cardFlip(card) {
        tech_answers.current_card = '';
        var cardBox = $('#' + card + 'Box');
        var cardFlip = $('#' + card + 'Flip');

        $('#flipContainer').hide();
        cardBox.css('opacity', 1);
        cardFlip.css('opacity', 0);
        cardFlip.hide();
        $('#textboxArea').hide();
        $('#controlButtons').show();
    }

    function cardFlip2(card) {
        tech_answers.current_card = '';
        var cardBox = $('#' + card + 'Box');
        var cardFlip = $('#' + card + 'Flip');

        cardBox.show();
        cardFlip.hide();
        $('#textboxArea').hide();
        $('#controlButtons').show();
    }

    function saveCardAnswer() {
        let answer = $('#txtAnswer').val().trim();
        let cardCheck = $('#' + tech_answers.current_card + 'Box svg');
        if (answer.length > 0) {
            cardCheck.show();
        } else {
            cardCheck.hide();
        }
        tech_answers[tech_answers.current_card] = answer;
        console.log('ANSWERS: ' + JSON.stringify(tech_answers));
        cardsReset2();
    }

    function cardsReset() {
        $("div[id$='Box']").css('opacity', 1);
        $("div[id$='Flip']").css('opacity', 0);
        $("div[id$='Flip']").hide();
        $('#flipContainer').hide();
        $('#textboxArea').hide();
        $('#controlButtons').show();
    }

    function cardsReset2() {
        $("div[id$='Box']").show();
        $("div[id$='Flip']").hide();
        $('#textboxArea').hide();
        $('#controlButtons').show();
    }

    function resetAnswers() {
        $("div[id$='Box'] svg").hide();
        return {
            tech: '',
            current_card: '',
            use: '',
            card1: '',
            card2: '',
            card3: '',
            card4: ''
        };
    }

    function changeTech() {
        tech_answers = resetAnswers();
        cardsReset2();
        $('#tarotCards').hide();
        showTechMenu();
    }

    function showTechMenu() {
        $('#techChoiceMenu img').css('filter', 'grayscale(0)');
        let techs = Object.keys(all_answers);
        for (index in techs) {
            $('#techChoiceMenu img[name="' + techs[index] + '"]').css('filter', 'grayscale(1)');
        }
        $('#techChoiceMenu').show();
        if(techs.length > 0) {
            $('#done-button').show().focus();
        }
    }

    function submitAnswers() {
        delete tech_answers.current_card;
        all_answers[tech_answers.tech] = tech_answers;
        LITW.data.submitStudyData(tech_answers);
        let toDeactivate = $('#techChoiceMenu img[name="' + tech_answers.tech + '"]');
        toDeactivate.prop('onclick', null).off('click');
        changeTech();
    }

    function finish() {
        LITW.study.sharedData.taroAnswers = all_answers;
        jsPsych.finishTrial();
    }

    function shuffleApps(){
        let categories = LITW.utils.shuffleArrays(Object.keys(technologies));
        for(let index = 1; index <= categories.length; index++) {
            let categoryID = 'category'+ index;
            let category = technologies[categories[index-1]];
            $('div[name="' + categoryID + '"]').attr('id', 'tech-' + category['id']);
            $('div[name="' + categoryID + '"] h2').html(category['name']);
            $('div[name="' + categoryID + '"] div[name="tech4"]').attr('id', 'addTech-' + category['id']);
            $('div[name="' + categoryID + '"] div[name="tech4"] svg')
                .attr('onclick', 'showAddTech("' + category['id'] + '")');

            let apps = LITW.utils.shuffleArrays(category['apps']);
            for(let index = 1; index <= apps.length; index++) {
                let app = $('div[name="' + categoryID + '"] div[name="tech' + index + '"] img');
                app.attr('src', apps[index-1].image);
                app.attr('name', apps[index-1].name);
                app.attr('alt', apps[index-1].description);
            }
        }
    }

    shuffleApps();
</script>